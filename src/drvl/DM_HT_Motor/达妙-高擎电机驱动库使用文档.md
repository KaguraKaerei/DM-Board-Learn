[TOC]

# 达妙-高擎电机驱动库使用文档

----

## 1. 概述

本库为 STM32（H7 系列）平台上 “达妙电机 / 高擎电机” 双栈驱动的统一封装，提供统一的电机 ID、模式、控制与反馈接口，底层通过 FDCAN 与电机通讯。



## 2. 特性

### 2.1. 设计理念

- **统一封装**：跨厂商的统一控制入口，支持高擎电机与达妙电机
- **简化使用**：对原生库繁杂的操作进行简化，并修正原始库部分BUG
- **双栈驱动**：底层分别基于 `HighTorque_Drive` 和 `DM_Drive` 实现
- **FDCAN 通讯**：通过 FDCAN 与电机进行高效数据交换
- **模式丰富**：支持多种控制模式（位置、速度、力矩、MIT 等）

### 2.2. 适用范围

- **高擎电机**：基于 HighTorque_Drive（`ht_*`）实现的控制与状态读取
- **达妙电机**：基于 DM_Drive（`dm_*`）实现的控制、参数读写与反馈解码
- **统一封装**：`d_HTDM_Driver.*` 提供跨厂商的统一控制入口



## 3. 文件结构

```bash
DM_HT_Motor/
├── d_HTDM_Driver.h          # 统一 ID/模式与跨厂商控制接口
├── d_HTDM_CAN.h             # FDCAN DLC、过滤器与基础发送封装
├── DM_Drive/
│   ├── dm_motor_drv.h       # 达妙控制、模式、参数读写与反馈解析
│   └── dm_motor_ctrl.h      # 达妙电机控制管理与弱回调声明
└── HighTorque_Drive/
    ├── ht_motor_control.h   # 高擎控制接口（位置/速度/力矩等）
    ├── ht_motor.h           # 高擎状态结构、端口映射、版本信息与状态处理入口
    ├── ht_libelybot_can.h   # 高擎底层帧编码与命令发送
    ├── ht_convert.h         # 单位/范围转换、力矩修正、MIT 编码辅助
    └── ht_motor_config.h    # 高擎零位与参数写入
```



## 4. 使用方法

### 4.1. 使用前配置

#### 4.1.1. 环境与依赖

- **带 FDCAN 外设的主控**：如达妙开发板 `STM32H723VGT6`

- **STM32H7 HAL FDCAN 驱动**：参考 `DM_HT_Motor_FDCAN_Example.ioc` 
- **底层 CAN 工具**：`can_filter_init()`、`can_send()` 封装于 `d_HTDM_CAN.h`

#### 4.1.2. 统一 ID 与模式

- **ID 约定**（见 `Motor_ID_e`）：
  - 高擎：`1~100`（例如：`MOTOR_HT_CHASSIS=1`, `MOTOR_HT_JOINT1=2`…）对应 ID 1~100
  - 达妙：`101~200`（例如：`MOTOR_DM_1=101`…）对应 ID 1~100
- **模式枚举**：
  - 达妙：`DM_MODE_MIT/POS/SPD/ PSI`（MIT 含 `pos/vel/torque/kp/kd`）
  - 高擎：`HT_MODE_DQ_VOLT/DQ_CURRENT/POS/VEL/TORQUE/POS_VEL/TRAPEZOID/MIT/STOP/BRAKE`

#### 4.1.3. 单位与数据转换（高擎 `ht_convert.h`）

- **位置/速度类型**：`pos_vel_type_t`（`RADIAN_2PI` 弧度，`ANGLE_360` 角度，`TURNS` 圈数）
- **转换函数**：`conv_to_turns()/conv_from_turns()`、`pos_float2int()/pos_int2float()`、`vel_*`、`tqe_*`、`acc_*`、`pid_*`
- **力矩修正**：`tqe_adjust()/tqe_restore()` 随电机型号 `motor_type_t` 修正映射
- **MIT 编码辅助**：`mit_float2int(x,x_min,x_max,bits)`；KP/KD 推荐范围 `KP_MAX=500`, `KD_MAX=5`（见达妙宏）

### 4.2. 初始化

```c
// 1. 统一驱动初始化
Motor_HTDM_Driver_Init();

// 2. 如需启动 CAN Filter
can_filter_init(&hfdcan1);
```

### 4.3. 统一封装接口`d_HTDM_Driver.h`

```c
// 高擎控制接口
Motor_HT_Set_DQVolt(id, d_volt, q_volt);
Motor_HT_Set_DQCurrent(id, d_cur, q_cur);
Motor_HT_Set_Position(id, pos);
Motor_HT_Set_Velocity(id, vel);
Motor_HT_Set_Torque(id, tqe);
Motor_HT_Set_PosVel(id, pos, vel);
Motor_HT_Set_PosVelAcc(id, pos, vel, acc);
Motor_HT_Set_MIT(id, pos, vel, kp, kd, tqe);
Motor_HT_Stop(id);
Motor_HT_Brake(id);

// 达妙控制接口
Motor_DM_Set_MIT(id, pos, vel, kp, kd, tor);
Motor_DM_Set_PosVel(id, pos, vel);
Motor_DM_Set_Velocity(id, vel);
Motor_DM_Set_PosVelCur(id, pos, vel, cur);

// 统一反馈
Motor_Get_Position(id);
Motor_Get_Velocity(id);
Motor_Get_Torque(id);  // 需结合各自状态源
```

初始化后调用各 API 即可。

### 4.4. 中断与接收集成

#### 4.4.1. FDCAN 接收中断处理

```c
void HAL_FDCAN_RxFifo0Callback(FDCAN_HandleTypeDef *hfdcan, uint32_t itflags) {
    FDCAN_RxHeaderTypeDef hdr; uint8_t buf[64];
    if (HAL_FDCAN_GetRxMessage(hfdcan, FDCAN_RX_FIFO0, &hdr, buf) != HAL_OK) return;

    // 高擎状态帧处理
    motor_process_state_frame(hfdcan, (uint8_t)hdr.Identifier, buf, hdr.DataLength);

    // 达妙反馈（根据 ID 映射找到数组下标并解析）
    uint8_t idx = /* 根据 hdr.Identifier -> dm_motor[idx] */;
    dm_motor_fbdata(&dm_motor[idx], buf);
}
```

#### 4.4.2. 过滤器与 DLC

- 使用 `can_filter_init()` 配置接收
- 使用 `get_fdcan_dlc()/get_fdcan_data_size()` 处理 DLC 与数据长度

## 5. API表格

### 5.1. 统一封装接口

| 函数                                           | 说明                         |
| ---------------------------------------------- | ---------------------------- |
| `Motor_HTDM_Driver_Init()`                     | 统一驱动初始化               |
| `Motor_HT_Set_DQVolt(id, d_volt, q_volt);`     | 设置高擎电机 DQ 轴电压       |
| `Motor_HT_Set_DQCurrent(id, d_cur, q_cur);`    | 设置高擎电机 DQ 轴电流       |
| `Motor_HT_Set_Position(id, pos);`              | 设置高擎电机目标位置         |
| `Motor_HT_Set_Velocity(id, vel);`              | 设置高擎电机目标速度         |
| `Motor_HT_Set_Torque(id, tqe);`                | 设置高擎电机目标力矩         |
| `Motor_HT_Set_PosVel(id, pos, vel);`           | 设置高擎电机目标位置速度     |
| `Motor_HT_Set_PosVelAcc(id, pos, vel, acc);`   | 设置高擎电机目标速度加速度   |
| `Motor_HT_Set_MIT(id, pos, vel, kp, kd, tqe);` | 设置高擎电机 MIT 参数        |
| `Motor_HT_Stop(id);`                           | 高擎电机停止(无力)           |
| `Motor_HT_Brake(id);`                          | 高擎电机刹车(有力)           |
| `Motor_DM_Set_MIT(id, pos, vel, kp, kd, tor);` | 设置达妙电机 MIT 参数        |
| `Motor_DM_Set_PosVel(id, pos, vel);`           | 设置达妙电机目标位置速度     |
| `Motor_DM_Set_Velocity(id, vel);`              | 设置达妙电机目标速度         |
| `Motor_DM_Set_PosVelCur(id, pos, vel, cur);`   | 设置达妙电机目标位置速度电流 |
| `Motor_Get_Position(id);`                      | 获取电机位置                 |
| `Motor_Get_Velocity(id);`                      | 获取电机速度                 |
| `Motor_Get_Torque(id);`                        | 获取电机力矩                 |

### 5.2. 底层CAN接口

| 函数                             | 说明            |
| -------------------------------- | --------------- |
| `can_filter_init(fdcan)`         | CAN过滤器初始化 |
| `can_send(fdcan, id, data, len)` | CAN数据发送     |
| `get_fdcan_dlc(len)`             | 获取DLC值       |
| `get_fdcan_data_size(dlc)`       | 获取数据长度    |

## 6. 常见问题与注意事项

### 6.1. ID 规划

- 确保高擎与达妙 ID 不重叠，并与电机端设定一致

### 6.2. 单位一致性

- 统一封装默认使用"弧度制"与"物理量"，如需圈数/角度，可用 `ht_convert.*` 转换

### 6.3. 力矩修正

- 高擎端强烈建议设置 `model`（电机型号），避免力矩映射误差

### 6.4. KP/KD 合理范围

- 达妙建议 `KP∈[0,500]`、`KD∈[0,5]`；超范围可能被限幅或导致不稳定

### 6.5. 中断接收

- 务必开启 FDCAN 接收中断，完成 `motor_process_state_frame` / `dm_motor_fbdata` 的接入

### 6.6. 参数写入

- 高擎使用 `conf_write()`；达妙使用 `write_motor_data()/save_motor_data()`
- 写入零位建议在机械静止时进行

### 6.7. 刹车与停止

- 测试时先用 `stop/brake` 验证安全
- 梯形/位置模式请确认加速度设置合理（达妙 `RID_ACC/DEC`）

## 7. 性能特点

- **统一接口**：跨厂商的统一控制入口，降低代码复杂度
- **双栈支持**：同时支持高擎和达妙两种电机
- **实时性**：基于 FDCAN 的高效通讯，适合实时控制场景
- **可配置性**：丰富的控制模式和参数配置选项

## 8. 编译要求

- **STM32 HAL 库**：需要 FDCAN 驱动支持
- **C 语言环境**：支持 C99 或更高标准
- **中断配置**：需要正确配置 FDCAN 接收中断

## 9. 版本历史

- **v1.0**
  - 实现高擎电机与达妙电机的统一封装
  - 提供跨厂商的统一控制接口
  - 支持多种控制模式和反馈解析